#!groovy
//preparing vault pipeline

@Library('uk-ets-rene')_
pipeline {
  agent {
	  node('master')
    }
  options {
    disableConcurrentBuilds()
  }
  environment {
    JAVA_HOME="/opt/openjdk-11.0.2"
    PATH="${env.JAVA_HOME}/bin:${env.PATH}"
    SONARTOKEN = credentials('sonarqube-token')
    NEXUS_DOCKER_PASSWORD = credentials('nexus_docker_password')
    NEXUS_REPOSITORY = "ukets-snapshots"
  }

  stages {
   stage('Branch Check') {
     steps {
       script {
	   reponame = determineRepoName()
           branchname = determineBranchName("${reponame}")
	   if("${branchname}" == 'master'){
		echo "[MASTER] Checking Out ${branchname} Branch"
           } else {
                echo "[PR] Checking Out ${branchname} Branch"
           }
       }
     }
   }

    stage('PR Checks') {
      when {
        expression { "${branchname}" != 'master' }
      }
      steps {
        script {
          echo "[PR] Running checks on ${branchname} Branch"
          mvnCleanVerify()
        }
      }
    }

   stage('Build&Push to Nexus') {
    when {
      expression { "${branchname}" == 'master' }
    }
     steps {
       script {
        jenkinsLibCommons_aws("${reponame}")
      }
     }
   }
  }
  post {
    always {
        sendNotificationsDetailed_aws ("${currentBuild.currentResult}","${branchname}")
	cleanWs()
     }
  }
 }
