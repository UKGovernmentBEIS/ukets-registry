<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="5_16_0_ACTIVITY_TYPE_TABLE" author="piliotid" context="migrate">
        <comment>Activity type table</comment>
        <sql>
            create sequence activity_type_seq minvalue 0 maxvalue 999999999999999999 increment by 1 start with 1 cache 1 no cycle;

            create table "activity_type"
            ("id" bigint,
            "compliant_entity_id" BIGINT NOT NULL,
            "description" VARCHAR(1020)  NOT NULL,
            constraint "pk_activity_type" primary key("id"));

            comment on table "activity_type" is 'Represents an activity type.';

            comment on column "activity_type"."id" is 'Surrogate key.';
            comment on column "activity_type"."compliant_entity_id" IS 'Foreign key to installation.';
            comment on column "activity_type"."description" is 'The activity type of the installation.';

            alter table "activity_type" add constraint "fk_activity_type_installation" foreign key ("compliant_entity_id")
            references "installation" ("compliant_entity_id");
            create unique index "unq_activity_type_installation" ON "activity_type" ("compliant_entity_id", "description");
        </sql>

        <rollback>
            <sql>
                drop table activity_type;
                drop sequence activity_type_seq;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="5_16_0_POPULATE_ACTIVITY_TYPE_TABLE" author="piliotid" context="migrate">
        <comment>Migrate data from installation table to activity type.</comment>
        <sql>
            insert into activity_type (id, compliant_entity_id, description)
            select nextval('activity_type_seq'), compliant_entity_id, activity_type from installation;
            alter table installation drop column if exists activity_type;
        </sql>
    </changeSet>

    <changeSet id="5_16_0_TABLE_METS_ACCOUNT_CONTACT_AND_ACCOUNT_CONTACT_TYPE" author="dimopoulosc" context="migrate">
        <comment>Defines the payment table</comment>
        <sql>
            CREATE SEQUENCE mets_account_contact_seq MINVALUE 0 MAXVALUE 999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 1 NO CYCLE;

            CREATE TABLE "mets_account_contact"
            (
                "id"                     BIGINT       NOT NULL,
                "contact_name"           VARCHAR(256) NOT NULL,
                "email_address"          VARCHAR(256) NOT NULL,
                "phone_number_1"         VARCHAR(256),
                "phone_number_1_country" VARCHAR(10),
                "phone_number_2"         VARCHAR(256),
                "phone_number_2_country" VARCHAR(10),
                "operator_type"          VARCHAR(50),
                "invited_date"           TIMESTAMP,
                "account_id"             BIGINT       NOT NULL,
                CONSTRAINT "pk_mets_account_contact" PRIMARY KEY ("id"),
                CONSTRAINT "fk_mets_account_contact_account" FOREIGN KEY ("account_id")
                    REFERENCES "account" ("id")
            );

            CREATE INDEX "idx_mets_account_contact_account_id" ON "mets_account_contact" ("account_id");

            COMMENT ON TABLE "mets_account_contact" IS 'METS contacts for an account';
            COMMENT ON COLUMN "mets_account_contact"."id" IS 'Primary key';
            COMMENT ON COLUMN "mets_account_contact"."account_id" IS 'FK to account table';
            COMMENT ON COLUMN "mets_account_contact"."contact_name" IS 'Contact name';
            COMMENT ON COLUMN "mets_account_contact"."email_address" IS 'Contact email';
            COMMENT ON COLUMN "mets_account_contact"."operator_type" IS 'Operator type (operator admin, operator, consultant/agent, emitter)';
            COMMENT ON COLUMN "mets_account_contact"."invited_date" IS 'Invitation timestamp';
            COMMENT ON COLUMN "mets_account_contact"."phone_number_1" IS 'Primary phone number for the contact';
            COMMENT ON COLUMN "mets_account_contact"."phone_number_1_country" IS 'Country code associated with primary phone number';
            COMMENT ON COLUMN "mets_account_contact"."phone_number_2" IS 'Secondary phone number for the contact';
            COMMENT ON COLUMN "mets_account_contact"."phone_number_2_country" IS 'Country code associated with secondary phone number';

            CREATE TABLE "mets_account_contact_type"
            (
                "mets_account_contact_id" BIGINT NOT NULL,
                "contact_type" VARCHAR(50) NOT NULL,
                CONSTRAINT "pk_mets_account_contact_type" PRIMARY KEY ("mets_account_contact_id", "contact_type"),
                CONSTRAINT "fk_mets_account_contact_type_contact" FOREIGN KEY ("mets_account_contact_id")
                    REFERENCES "mets_account_contact" ("id") ON DELETE CASCADE
            );

            COMMENT ON TABLE "mets_account_contact_type" IS 'Contact types assigned to an account contact';
            COMMENT ON COLUMN "mets_account_contact_type"."mets_account_contact_id" IS 'FK to METS account_contact';
            COMMENT ON COLUMN "mets_account_contact_type"."contact_type" IS 'Contact type (Primary, Secondary, Service, Financial)';

            CREATE INDEX "idx_mets_account_contact_type_contact_type" ON "mets_account_contact_type" ("mets_account_contact_id");
        </sql>
        <rollback>
            <sql>
                DROP TABLE IF EXISTS "mets_account_contact_type" CASCADE;
                DROP TABLE IF EXISTS "mets_account_contact" CASCADE;
                DROP SEQUENCE IF EXISTS mets_account_contact_seq;
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>